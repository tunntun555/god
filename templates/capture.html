<!DOCTYPE html>
<html lang="th">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>üì∏ Photo Booth - ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏ö</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;800;900&family=Major+Mono+Display&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #FF6B6B;
			--primary-dark: #EE5A52;
			--secondary: #4ECDC4;
			--accent: #FFE66D;
			--dark: #1A1A2E;
			--dark-light: #2D2D44;
			--light: #F7F7F7;
			--text: #EAEAEA;
			--success: #51CF66;
			--warning: #FF8B42;
			--shadow: rgba(0, 0, 0, 0.3);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Barlow', sans-serif;
			background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
			min-height: 100vh;
			overflow-x: hidden;
			position: relative;
		}

		/* Background Animation */
		body::before {
			content: '';
			position: fixed;
			top: -50%;
			left: -50%;
			width: 200%;
			height: 200%;
			background: 
				radial-gradient(circle at 20% 50%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
				radial-gradient(circle at 80% 80%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
				radial-gradient(circle at 40% 20%, rgba(255, 230, 109, 0.05) 0%, transparent 50%);
			animation: float 20s ease-in-out infinite;
			pointer-events: none;
		}

		@keyframes float {
			0%, 100% { transform: translate(0, 0) rotate(0deg); }
			33% { transform: translate(30px, -30px) rotate(5deg); }
			66% { transform: translate(-20px, 20px) rotate(-5deg); }
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
			padding: 20px;
			position: relative;
			z-index: 1;
		}

		/* Header */
		.header {
			text-align: center;
			margin-bottom: 40px;
			animation: slideDown 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
		}

		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-30px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.header h1 {
			font-family: 'Major Mono Display', monospace;
			font-size: clamp(2rem, 5vw, 3.5rem);
			color: var(--text);
			margin-bottom: 10px;
			letter-spacing: 2px;
			text-shadow: 0 0 30px rgba(255, 107, 107, 0.5);
			position: relative;
			display: inline-block;
		}

		.header h1::after {
			content: '';
			position: absolute;
			bottom: -10px;
			left: 50%;
			transform: translateX(-50%);
			width: 60%;
			height: 3px;
			background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
			border-radius: 10px;
		}

		.header p {
			color: var(--text);
			font-size: 1.2rem;
			opacity: 0.8;
			font-weight: 500;
			margin-top: 20px;
		}

		/* Status Bar */
		.status-bar {
			display: flex;
			justify-content: space-between;
			gap: 15px;
			margin-bottom: 30px;
			flex-wrap: wrap;
			animation: fadeIn 0.8s ease 0.2s both;
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(20px); }
			to { opacity: 1; transform: translateY(0); }
		}

		.status-card {
			flex: 1;
			min-width: 200px;
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 20px;
			padding: 20px;
			display: flex;
			align-items: center;
			gap: 15px;
			transition: all 0.3s ease;
		}

		.status-card:hover {
			background: rgba(255, 255, 255, 0.08);
			transform: translateY(-2px);
			box-shadow: 0 10px 30px var(--shadow);
		}

		.status-icon {
			width: 50px;
			height: 50px;
			border-radius: 15px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
			background: linear-gradient(135deg, var(--primary), var(--primary-dark));
		}

		.status-card:nth-child(2) .status-icon {
			background: linear-gradient(135deg, var(--secondary), #3DBDB4);
		}

		.status-info h3 {
			color: var(--text);
			font-size: 0.9rem;
			opacity: 0.7;
			font-weight: 500;
			margin-bottom: 5px;
		}

		.status-info p {
			color: var(--text);
			font-size: 1.3rem;
			font-weight: 700;
		}

		.status-online {
			color: var(--success);
		}

		.status-offline {
			color: var(--warning);
		}

		/* Camera Section */
		.camera-section {
			animation: fadeIn 0.8s ease 0.4s both;
		}

		.camera-container {
			position: relative;
			width: 100%;
			max-width: 700px;
			margin: 0 auto 30px;
			border-radius: 30px;
			overflow: hidden;
			background: #000;
			box-shadow: 
				0 20px 60px rgba(0, 0, 0, 0.5),
				0 0 0 1px rgba(255, 255, 255, 0.1);
		}

		#video {
			width: 100%;
			height: auto;
			display: block;
		}

		.camera-placeholder {
			width: 100%;
			min-height: 400px;
			background: linear-gradient(135deg, var(--dark-light) 0%, var(--dark) 100%);
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			color: var(--text);
			padding: 40px;
			text-align: center;
		}

		.camera-placeholder i {
			font-size: 5rem;
			margin-bottom: 30px;
			opacity: 0.5;
			animation: pulse 2s ease-in-out infinite;
		}

		@keyframes pulse {
			0%, 100% { transform: scale(1); opacity: 0.5; }
			50% { transform: scale(1.1); opacity: 0.8; }
		}

		.camera-placeholder h3 {
			font-size: 1.8rem;
			margin-bottom: 15px;
			font-weight: 700;
		}

		.camera-placeholder p {
			margin-bottom: 10px;
			line-height: 1.6;
			opacity: 0.8;
		}

		/* Countdown Overlay */
		.countdown-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 10;
		}

		.countdown-text {
			font-size: 150px;
			font-weight: 900;
			color: white;
			text-shadow: 0 0 50px var(--primary);
			animation: countdownPulse 1s ease-in-out;
		}

		@keyframes countdownPulse {
			0% { transform: scale(0.5); opacity: 0; }
			50% { transform: scale(1.2); }
			100% { transform: scale(1); opacity: 1; }
		}

		/* Controls */
		.controls {
			max-width: 700px;
			margin: 0 auto;
			animation: fadeIn 0.8s ease 0.6s both;
		}

		.buttons {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
		}

		.btn {
			padding: 18px 35px;
			font-size: 1.1rem;
			border: none;
			border-radius: 50px;
			cursor: pointer;
			font-weight: 700;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 12px;
			min-width: 180px;
			transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
			font-family: 'Barlow', sans-serif;
			text-transform: uppercase;
			letter-spacing: 1px;
			position: relative;
			overflow: hidden;
		}

		.btn::before {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.2);
			transform: translate(-50%, -50%);
			transition: width 0.6s, height 0.6s;
		}

		.btn:hover::before {
			width: 300px;
			height: 300px;
		}

		.btn span, .btn i {
			position: relative;
			z-index: 1;
		}

		.btn-primary {
			background: linear-gradient(135deg, var(--primary), var(--primary-dark));
			color: white;
			box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
		}

		.btn-success {
			background: linear-gradient(135deg, var(--success), #47B85F);
			color: white;
			box-shadow: 0 10px 30px rgba(81, 207, 102, 0.4);
		}

		.btn-warning {
			background: linear-gradient(135deg, var(--warning), #FF7830);
			color: white;
			box-shadow: 0 10px 30px rgba(255, 139, 66, 0.4);
		}

		.btn-secondary {
			background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
			color: var(--text);
			border: 2px solid rgba(255, 255, 255, 0.2);
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
		}

		.btn-frame {
			background: linear-gradient(135deg, var(--secondary), #3DBDB4);
			color: white;
			box-shadow: 0 10px 30px rgba(78, 205, 196, 0.4);
		}

		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			transform: none !important;
		}

		.btn:hover:not(:disabled) {
			transform: translateY(-3px) scale(1.02);
		}

		.btn:active:not(:disabled) {
			transform: translateY(0) scale(0.98);
		}

		/* Messages */
		.message-area {
			max-width: 700px;
			margin: 30px auto 0;
			min-height: 60px;
		}

		.message {
			padding: 20px 30px;
			border-radius: 20px;
			text-align: center;
			font-size: 1.1rem;
			font-weight: 600;
			animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		@keyframes slideUp {
			from { opacity: 0; transform: translateY(20px); }
			to { opacity: 1; transform: translateY(0); }
		}

		.message-success {
			background: rgba(81, 207, 102, 0.2);
			color: var(--success);
			border-color: var(--success);
		}

		.message-error {
			background: rgba(255, 107, 107, 0.2);
			color: var(--primary);
			border-color: var(--primary);
		}

		.message-info {
			background: rgba(78, 205, 196, 0.2);
			color: var(--secondary);
			border-color: var(--secondary);
		}

		.message-warning {
			background: rgba(255, 139, 66, 0.2);
			color: var(--warning);
			border-color: var(--warning);
		}

		/* Preview Section */
		.preview-section {
			max-width: 700px;
			margin: 30px auto 0;
			padding: 30px;
			background: rgba(255, 255, 255, 0.05);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 30px;
			display: none;
			animation: fadeIn 0.6s ease;
		}

		.preview-section h3 {
			color: var(--text);
			margin-bottom: 20px;
			font-size: 1.5rem;
			font-weight: 700;
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.preview-images {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 20px;
			margin-top: 20px;
		}

		.preview-img-wrapper {
			position: relative;
			aspect-ratio: 1;
			border-radius: 20px;
			overflow: hidden;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
		}

		@keyframes scaleIn {
			from { opacity: 0; transform: scale(0.8); }
			to { opacity: 1; transform: scale(1); }
		}

		.preview-img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: transform 0.3s ease;
		}

		.preview-img-wrapper:hover .preview-img {
			transform: scale(1.1);
		}

		.preview-number {
			position: absolute;
			top: 10px;
			right: 10px;
			width: 35px;
			height: 35px;
			background: linear-gradient(135deg, var(--primary), var(--primary-dark));
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 700;
			font-size: 1rem;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
		}

		/* QR Display */
		.qr-display {
			text-align: center;
			padding: 40px;
			background: linear-gradient(135deg, var(--primary), var(--secondary));
			border-radius: 30px;
			margin-top: 20px;
			animation: scaleIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
		}

		.qr-display h2 {
			color: white;
			font-size: 2.5rem;
			margin-bottom: 20px;
			font-weight: 900;
			text-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
		}

		.qr-display p {
			color: white;
			font-size: 1.3rem;
			line-height: 1.8;
			margin-bottom: 20px;
			font-weight: 600;
		}

		/* Frame Modal */
		.frame-modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			z-index: 9999;
			overflow-y: auto;
			padding: 20px;
			display: none;
		}

		.frame-modal-content {
			max-width: 1200px;
			margin: 0 auto;
			background: var(--dark-light);
			border-radius: 20px;
			padding: 30px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
		}

		.frame-modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			color: var(--text);
		}

		.frame-modal-header h2 {
			font-size: 2rem;
			margin: 0;
		}

		.close-modal {
			background: none;
			border: none;
			color: var(--text);
			font-size: 2.5rem;
			cursor: pointer;
			padding: 0;
			width: 40px;
			height: 40px;
			line-height: 1;
			transition: color 0.3s;
		}

		.close-modal:hover {
			color: var(--primary);
		}

		.frame-options {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 20px;
		}

		.frame-option {
			background: rgba(255, 255, 255, 0.05);
			border: 2px solid rgba(255, 255, 255, 0.1);
			border-radius: 15px;
			padding: 20px;
			text-align: center;
			transition: all 0.3s;
		}

		.frame-option:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: var(--primary);
			transform: translateY(-5px);
		}

		.frame-preview {
			min-height: 200px;
			background: rgba(0, 0, 0, 0.3);
			border-radius: 10px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			margin-bottom: 15px;
			color: var(--text);
			padding: 20px;
		}

		.frame-preview img {
			max-width: 100%;
			max-height: 200px;
			border-radius: 8px;
		}

		.frame-option h3 {
			color: var(--text);
			font-size: 1.1rem;
			margin-bottom: 10px;
		}

		.frame-option-info {
			font-size: 0.85rem;
			color: rgba(255, 255, 255, 0.6);
			margin-bottom: 15px;
		}

		.select-frame-btn {
			width: 100%;
			padding: 12px;
			background: linear-gradient(135deg, var(--primary), var(--primary-dark));
			border: none;
			border-radius: 10px;
			color: white;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
		}

		.select-frame-btn:hover {
			transform: scale(1.05);
			box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
		}

		/* Responsive */
		@media (max-width: 768px) {
			.header h1 {
				font-size: 2rem;
			}

			.status-bar {
				flex-direction: column;
			}

			.buttons {
				flex-direction: column;
			}

			.btn {
				width: 100%;
			}

			.countdown-text {
				font-size: 100px;
			}
			
			.frame-modal-content {
				padding: 20px;
			}
		}

		/* Loading Animation */
		.spinner {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 3px solid rgba(255, 255, 255, 0.3);
			border-radius: 50%;
			border-top-color: white;
			animation: spin 0.8s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}
	</style>
</head>
<body>
	<div class="container">
		<!-- Header -->
		<div class="header">
			<h1>üì∏ PHOTO BOOTH</h1>
			<p>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏ß‡∏¢‡πÜ ‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
		</div>

		<!-- Status Bar -->
		<div class="status-bar">
			<div class="status-card">
				<div class="status-icon">
					<i class="fas fa-video"></i>
				</div>
				<div class="status-info">
					<h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á</h3>
					<p id="cameraStatusText" class="status-offline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î...</p>
				</div>
			</div>
			<div class="status-card">
				<div class="status-icon">
					<i class="fas fa-images"></i>
				</div>
				<div class="status-info">
					<h3>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢</h3>
					<p><span id="photoCounter">0</span> / <span id="maxPhotos">4</span></p>
				</div>
			</div>
		</div>

		<!-- Camera Section -->
		<div class="camera-section">
			<div class="camera-container">
				<video id="video" autoplay playsinline></video>
				<div class="camera-placeholder" id="cameraPlaceholder">
					<i class="fas fa-camera-retro"></i>
					<h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á...</h3>
					<p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</p>
				</div>
				<div class="countdown-overlay" id="countdownOverlay">
					<span class="countdown-text" id="countdownText">3</span>
				</div>
			</div>

			<!-- Controls -->
			<div class="controls">
				<div class="buttons">
					<button id="captureBtn" class="btn btn-primary" onclick="capturePhoto()">
						<i class="fas fa-camera"></i>
						<span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
					</button>
					<button id="retakeBtn" class="btn btn-warning" onclick="retakeAllPhotos()" style="display: none;">
						<i class="fas fa-redo"></i>
						<span>‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</span>
					</button>
					<button id="frameBtn" class="btn btn-frame" onclick="showFrameSelection()" style="display: none;">
						<i class="fas fa-border-all"></i>
						<span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
					</button>
					<button id="finishBtn" class="btn btn-success" onclick="finishSession()" style="display: none;">
						<i class="fas fa-check-circle"></i>
						<span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏ö)</span>
					</button>
					<button id="resetBtn" class="btn btn-secondary" onclick="resetSessionWithConfirm()" style="display: none;">
						<i class="fas fa-times-circle"></i>
						<span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
					</button>
				</div>
			</div>

			<!-- Message Area -->
			<div class="message-area">
				<div id="messageContainer"></div>
			</div>

			<!-- Preview Section -->
			<div class="preview-section" id="previewSection">
				<h3><i class="fas fa-images"></i> ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
				<div class="preview-images" id="previewImages"></div>
			</div>
		</div>
	</div>

	<!-- Frame Selection Modal -->
	<div id="frameModal" class="frame-modal">
		<div class="frame-modal-content">
			<div class="frame-modal-header">
				<h2>üñºÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ</h2>
				<button class="close-modal" onclick="closeFrameModal()">&times;</button>
			</div>
			
			<div class="frame-options">
				<!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏ö -->
				<div class="frame-option" data-template-id="none">
					<div class="frame-preview">
						<i class="fas fa-images" style="font-size: 3rem; color: #666;"></i>
						<p style="margin-top: 10px;">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏ö (4 ‡∏£‡∏π‡∏õ‡πÅ‡∏¢‡∏Å)</p>
					</div>
					<button class="select-frame-btn" onclick="selectFrame('none')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
				</div>
				
				<!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏à‡∏≤‡∏Å templates -->
				<div id="frameTemplatesList"></div>
			</div>
		</div>
	</div>

	<script>
		// ============================================
		// Global Variables
		// ============================================
		let stream = null;
		let video = document.getElementById('video');
		let cameraPlaceholder = document.getElementById('cameraPlaceholder');
		let captureBtn = document.getElementById('captureBtn');
		let retakeBtn = document.getElementById('retakeBtn');
		let frameBtn = document.getElementById('frameBtn');
		let finishBtn = document.getElementById('finishBtn');
		let resetBtn = document.getElementById('resetBtn');
		let photoCounter = document.getElementById('photoCounter');
		let maxPhotos = document.getElementById('maxPhotos');
		let messageContainer = document.getElementById('messageContainer');
		let previewSection = document.getElementById('previewSection');
		let previewImages = document.getElementById('previewImages');
		let countdownOverlay = document.getElementById('countdownOverlay');
		let countdownText = document.getElementById('countdownText');
		let cameraStatusText = document.getElementById('cameraStatusText');

		let photos = [];
		let currentMaxPhotos = 4; // ‡∏ñ‡πà‡∏≤‡∏¢ 4 ‡∏£‡∏π‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
		let currentPickupCode = null;
		let isProcessing = false;
		let retakeAvailable = true;
		let selectedTemplateId = null;
		let processingTimeout = null;

		// ============================================
		// Camera Functions
		// ============================================
		async function checkIfReadyForNewUser() {
			try {
				const response = await fetch('/api/full_status');
				const data = await response.json();
				
				const ready = !data.camera_locked && photos.length === 0 && !isProcessing;
				
				console.log('üë§ Ready for new user check:', {
					ready: ready,
					camera_locked: data.camera_locked,
					photosLength: photos.length,
					isProcessing: isProcessing
				});
				
				return ready;
			} catch (error) {
				console.error('Ready check error:', error);
				return false;
			}
		}

		async function checkAutoReset() {
			try {
				const response = await fetch('/api/camera_status');
				const data = await response.json();
				
				if (!data.camera_locked && currentPickupCode && photos.length === 0) {
					console.log('‚úÖ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ú‡πà‡∏≤‡∏ô ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö...');
					performReset();
					showMessage('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', 'success', 3000);
					currentPickupCode = null;
				}
			} catch (error) {
				console.log('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏î‡πâ:', error);
			}
		}

		function performReset() {
			console.log('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô...');
			
			photos = [];
			photoCounter.textContent = '0';
			previewImages.innerHTML = '';
			previewSection.style.display = 'none';
			
			captureBtn.disabled = false;
			captureBtn.style.display = 'inline-flex';
			captureBtn.innerHTML = '<i class="fas fa-camera"></i><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>';
			
			retakeBtn.style.display = 'none';
			frameBtn.style.display = 'none';
			finishBtn.style.display = 'none';
			resetBtn.style.display = 'none';
			
			currentPickupCode = null;
			retakeAvailable = true;
			isProcessing = false;
			selectedTemplateId = null;
			
			messageContainer.innerHTML = '';
			
			console.log('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
		}

		async function initCamera() {
			try {
				if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
					showMessage('‚ö†Ô∏è ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á', 'error');
					cameraStatusText.textContent = '‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö';
					cameraStatusText.className = 'status-offline';
					showCameraPlaceholder();
					return;
				}

				stream = await navigator.mediaDevices.getUserMedia({
					video: {
						width: { ideal: 1280 },
						height: { ideal: 720 },
						facingMode: 'user'
					},
					audio: false
				});

				video.srcObject = stream;
				video.style.display = 'block';
				cameraPlaceholder.style.display = 'none';
				cameraActive = true;
				
				cameraStatusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
				cameraStatusText.className = 'status-online';
				
				showMessage('‚úÖ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!', 'success', 3000);
				captureBtn.disabled = false;

			} catch (error) {
				console.error('Camera error:', error);
				cameraActive = false;
				showCameraPlaceholder();
				captureBtn.disabled = true;
				
				cameraStatusText.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
				cameraStatusText.className = 'status-offline';
				showMessage('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error');
			}
		}

		function showCameraPlaceholder() {
			video.style.display = 'none';
			cameraPlaceholder.style.display = 'flex';
		}

		function resetSessionWithConfirm() {
			if (confirm('ü§î ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà?\n\n‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')) {
				resetSession();
			}
		}

		// ============================================
		// Photo Capture Functions
		// ============================================
		async function capturePhoto() {
			if (photos.length === 0) {
				const ready = await checkIfReadyForNewUser();
				if (!ready) {
					showMessage('‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'warning', 2000);
					return;
				}
			}
			
			if (!cameraActive) {
				showMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô', 'warning', 3000);
				return;
			}

			if (isProcessing) {
				return;
			}

			if (photos.length >= currentMaxPhotos) {
				showMessage('‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö 4 ‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß!', 'info', 3000);
				return;
			}

			isProcessing = true;
			captureBtn.disabled = true;
			captureBtn.innerHTML = '<div class="spinner"></div><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°...</span>';

			await startCountdown(3);

			try {
				const canvas = document.createElement('canvas');
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				const ctx = canvas.getContext('2d');
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
				
				const photoData = canvas.toDataURL('image/jpeg', 0.9);
				photos.push(photoData);
				
				displayPreview(photoData, photos.length);
				photoCounter.textContent = photos.length;
				
				if (photos.length >= currentMaxPhotos) {
					captureBtn.style.display = 'none';
					retakeBtn.style.display = 'inline-flex';
					frameBtn.style.display = 'inline-flex';
					finishBtn.style.display = 'inline-flex';
					resetBtn.style.display = 'inline-flex';
					
					isProcessing = false;
					showMessage('üéâ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö 4 ‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'success', 10000);
				} else {
					isProcessing = false;
					captureBtn.disabled = false;
					captureBtn.innerHTML = '<i class="fas fa-camera"></i><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>';
					showMessage(`üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å ${currentMaxPhotos - photos.length} ‡∏£‡∏π‡∏õ`, 'info', 2000);
					
					setTimeout(() => {
						if (photos.length < currentMaxPhotos && !isProcessing) {
							capturePhoto();
						}
					}, 2000);
				}
			} catch (error) {
				console.error('Capture error:', error);
				showMessage('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', 'error');
				captureBtn.disabled = false;
				captureBtn.innerHTML = '<i class="fas fa-camera"></i><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>';
				isProcessing = false;
			}
		}

		async function startCountdown(seconds) {
			countdownOverlay.style.display = 'flex';
			
			for (let i = seconds; i > 0; i--) {
				countdownText.textContent = i;
				countdownText.style.animation = 'none';
				setTimeout(() => {
					countdownText.style.animation = 'countdownPulse 1s ease-in-out';
				}, 10);
				await sleep(1000);
			}
			
			countdownText.textContent = 'üì∏';
			await sleep(300);
			
			countdownOverlay.style.display = 'none';
		}

		function displayPreview(photoData, number) {
			previewSection.style.display = 'block';
			
			const wrapper = document.createElement('div');
			wrapper.className = 'preview-img-wrapper';
			
			const img = document.createElement('img');
			img.src = photoData;
			img.className = 'preview-img';
			img.alt = `‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${number}`;
			
			const numberBadge = document.createElement('div');
			numberBadge.className = 'preview-number';
			numberBadge.textContent = number;
			
			wrapper.appendChild(img);
			wrapper.appendChild(numberBadge);
			previewImages.appendChild(wrapper);
		}

		// ‚úÖ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
		async function retakeAllPhotos() {
			if (!retakeAvailable || isProcessing) {
				showMessage('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'warning');
				return;
			}
			
			photos = [];
			photoCounter.textContent = '0';
			previewImages.innerHTML = '';
			
			retakeBtn.style.display = 'none';
			frameBtn.style.display = 'none';
			finishBtn.style.display = 'none';
			resetBtn.style.display = 'none';
			
			captureBtn.style.display = 'inline-flex';
			captureBtn.disabled = false;
			captureBtn.innerHTML = '<i class="fas fa-camera"></i><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>';
			
			retakeAvailable = false;
			
			showMessage('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!', 'info', 2000);
			
			setTimeout(() => {
				capturePhoto();
			}, 2000);
		}

		// ============================================
		// Frame Functions
		// ============================================
		function showFrameSelection() {
			loadFrameTemplates();
			document.getElementById('frameModal').style.display = 'block';
		}

		function closeFrameModal() {
			document.getElementById('frameModal').style.display = 'none';
		}

		async function loadFrameTemplates() {
			try {
				const response = await fetch('/api/frame_templates');
				const data = await response.json();
				
				const container = document.getElementById('frameTemplatesList');
				container.innerHTML = '';
				
				if (data.templates && data.templates.length > 0) {
					data.templates.forEach(template => {
						const option = document.createElement('div');
						option.className = 'frame-option';
						option.dataset.templateId = template.id;
						
						let previewHTML = '';
						if (template.frame_image_id) {
							previewHTML = `<img src="/frame/${template.frame_image_id}" alt="${template.name}">`;
						} else {
							previewHTML = `<i class="fas fa-border-all" style="font-size: 3rem; color: #666;"></i>`;
						}
						
						option.innerHTML = `
							<div class="frame-preview">
								${previewHTML}
							</div>
							<h3>${template.name}</h3>
							<div class="frame-option-info">
								${template.orientation === 'vertical' ? 'üì± ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á' : 'üì∫ ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô'}<br>
								${template.canvas_width} √ó ${template.canvas_height} px
							</div>
							<button class="select-frame-btn" onclick="selectFrame('${template.id}')">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
						`;
						
						container.appendChild(option);
					});
				}
			} catch (error) {
				console.error('Error loading templates:', error);
			}
		}

		function selectFrame(templateId) {
			selectedTemplateId = templateId;
			closeFrameModal();
			
			if (templateId === 'none') {
				finishSession();
			} else {
				finishSessionWithFrame(templateId);
			}
		}

		async function finishSessionWithFrame(templateId) {
			if (photos.length === 0) {
				showMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô', 'warning', 3000);
				return;
			}

			if (isProcessing) {
				showMessage('‚è≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'warning', 3000);
				return;
			}

			isProcessing = true;
			frameBtn.disabled = true;
			frameBtn.innerHTML = '<div class="spinner"></div><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ...</span>';
			
			processingTimeout = setTimeout(() => {
				if (isProcessing) {
					isProcessing = false;
					frameBtn.disabled = false;
					frameBtn.innerHTML = '<i class="fas fa-border-all"></i><span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>';
					showMessage('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error', 3000);
				}
			}, 10000);
			
			try {
				const response = await fetch('/api/upload', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ 
						photos: photos,
						template_id: templateId
					})
				});
				
				const data = await response.json();
				clearTimeout(processingTimeout);
				
				if (data.success) {
					currentPickupCode = data.pickup_code;
					
					let message = '';
					if (data.is_composite) {
						message = `
							<div class="qr-display">
								<h2>üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
								<p>üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡πÅ‡∏Å‡∏ô QR Code<br>‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
							</div>
						`;
					} else {
						message = `
							<div class="qr-display">
								<h2>üéâ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
								<p>üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡πÅ‡∏Å‡∏ô QR Code<br>‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
							</div>
						`;
					}
					
					showMessage(message, 'success', 30000);
			
					captureBtn.style.display = 'none';
					retakeBtn.style.display = 'none';
					frameBtn.style.display = 'none';
					finishBtn.style.display = 'none';
					resetBtn.style.display = 'none';
					
					photos = [];
					retakeAvailable = true;
					
					console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏´‡∏±‡∏™:', currentPickupCode);
				} else {
					isProcessing = false;
					showMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`, 'error', 5000);
					frameBtn.disabled = false;
					frameBtn.innerHTML = '<i class="fas fa-border-all"></i><span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>';
				}
			} catch (error) {
				console.error('Finish session error:', error);
				
				clearTimeout(processingTimeout);
				isProcessing = false;
				showMessage('‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error', 5000);
				frameBtn.disabled = false;
				frameBtn.innerHTML = '<i class="fas fa-border-all"></i><span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>';
			}
		}

		// ============================================
		// Finish Session (No Frame)
		// ============================================
		async function finishSession() {
			if (photos.length === 0) {
				showMessage('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô', 'warning', 3000);
				return;
			}

			if (isProcessing) {
				showMessage('‚è≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'warning', 3000);
				return;
			}

			isProcessing = true;
			finishBtn.disabled = true;
			finishBtn.innerHTML = '<div class="spinner"></div><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>';
			
			processingTimeout = setTimeout(() => {
				if (isProcessing) {
					isProcessing = false;
					finishBtn.disabled = false;
					finishBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏ö)</span>';
					showMessage('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error', 3000);
				}
			}, 10000);

			try {
				const response = await fetch('/api/upload', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ 
						photos: photos,
						template_id: 'none'
					})
				});
				
				const data = await response.json();
				clearTimeout(processingTimeout);
				
				if (data.success) {
					currentPickupCode = data.pickup_code;
					
					const qrMessage = `
						<div class="qr-display">
							<h2>üéâ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
							<p>üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡πÅ‡∏Å‡∏ô QR Code<br>‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
						</div>
					`;
					
					showMessage(qrMessage, 'success', 30000);
        
					captureBtn.style.display = 'none';
					retakeBtn.style.display = 'none';
					frameBtn.style.display = 'none';
					finishBtn.style.display = 'none';
					resetBtn.style.display = 'none';
					
					photos = [];
					retakeAvailable = true;
					
					console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏´‡∏±‡∏™:', currentPickupCode);
				} else {
					isProcessing = false;
					showMessage(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`, 'error', 5000);
					finishBtn.disabled = false;
					finishBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏ö)</span>';
				}
			} catch (error) {
				console.error('Finish session error:', error);
				
				clearTimeout(processingTimeout);
				isProcessing = false;
				showMessage('‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error', 5000);
				finishBtn.disabled = false;
				finishBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏ö)</span>';
			}
		}

		function resetSession() {
			fetch('/api/camera_status')
				.then(response => response.json())
				.then(data => {
					if (data.camera_locked) {
						showMessage('üîí ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô', 'warning');
						return;
					}
					performReset();
				})
				.catch(() => {
					if (confirm('ü§î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
						performReset();
					}
				});
		}

		// ============================================
		// Utility Functions
		// ============================================
		function showMessage(text, type = 'info', duration = 5000) {
			const message = document.createElement('div');
			message.className = `message message-${type}`;
			message.innerHTML = text;
			messageContainer.innerHTML = '';
			messageContainer.appendChild(message);
			
			setTimeout(() => {
				if (message.parentNode === messageContainer) {
					message.style.opacity = '0';
					setTimeout(() => message.remove(), 500);
				}
			}, duration);
		}

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

		// ============================================
		// Initialize
		// ============================================
		document.addEventListener('DOMContentLoaded', function() {
			initCamera();
			
			currentMaxPhotos = 4;
			maxPhotos.textContent = currentMaxPhotos;
			
			setInterval(checkAutoReset, 2000);
			
			setTimeout(() => {
				checkAutoReset();
			}, 1000);
			
			window.addEventListener('beforeunload', function(e) {
				if (photos.length > 0 && !isProcessing) {
					e.preventDefault();
					e.returnValue = '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?';
					return e.returnValue;
				}
			});
		});
	</script>
</body>
</html>
