{% extends "layout.html" %}

{% block title %}จัดการระบบ - Photo Booth Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Header Section -->
    <header class="admin-header">
        <div class="header-content">
            <h1><i class="fas fa-cog"></i> Photo Booth Admin</h1>
            <p class="subtitle">จัดการระบบสำหรับงานอีเวนต์</p>
        </div>
        <div class="server-info">
            <span class="info-item">
                <i class="fas fa-server"></i> us1.bot-hosting.net:21555
            </span>
            <span class="info-item">
                <i class="fas fa-clock"></i> 
                <span id="serverTime">กำลังโหลด...</span>
            </span>
        </div>
    </header>

    <!-- System Status Section -->
    <section class="system-status">
        <h2 class="section-title">
            <i class="fas fa-heartbeat"></i> สถานะระบบ
        </h2>
        <div class="status-grid">
            <div class="status-card status-online">
                <i class="fas fa-plug status-icon"></i>
                <h3>เซิร์ฟเวอร์</h3>
                <span class="status-badge">ONLINE</span>
            </div>
            
            <div class="status-card {% if camera_locked %}status-locked{% else %}status-unlocked{% endif %}">
                <i class="fas fa-camera status-icon"></i>
                <h3>เครื่องถ่ายรูป</h3>
                <span class="status-badge">
                    {% if camera_locked %}LOCKED{% else %}UNLOCKED{% endif %}
                </span>
            </div>
            
            <div class="status-card status-active">
                <i class="fas fa-qrcode status-icon"></i>
                <h3>QR Display</h3>
                <span class="status-badge">ACTIVE</span>
            </div>
            
            <div class="status-card status-normal">
                <i class="fas fa-database status-icon"></i>
                <h3>ฐานข้อมูล</h3>
                <span class="status-badge">NORMAL</span>
            </div>
        </div>
    </section>

    <!-- Statistics Section -->
    <section class="statistics-section">
        <h2 class="section-title">
            <i class="fas fa-chart-bar"></i> สถิติการใช้งาน
        </h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <div class="stat-content">
                    <h3>รูปทั้งหมด</h3>
                    <div class="stat-number">{{ stats.total_photos|default(0) }}</div>
                    <div class="stat-sub">รูปภาพ</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-download"></i>
                </div>
                <div class="stat-content">
                    <h3>ดาวน์โหลด</h3>
                    <div class="stat-number">{{ stats.total_downloads|default(0) }}</div>
                    <div class="stat-sub">ครั้ง</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3>เซสชัน</h3>
                    <div class="stat-number">{{ stats.total_sessions|default(0) }}</div>
                    <div class="stat-sub">คน</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-redo"></i>
                </div>
                <div class="stat-content">
                    <h3>ถ่ายใหม่</h3>
                    <div class="stat-number">{{ stats.retake_used|default(0) }}</div>
                    <div class="stat-sub">ครั้ง</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Device Management Section -->
    <section class="device-management">
        <h2 class="section-title">
            <i class="fas fa-desktop"></i> จัดการเครื่องใช้งาน
        </h2>
        
        <div class="device-grid">
            <!-- Capture Devices -->
            <article class="device-card">
                <header class="card-header">
                    <h3><i class="fas fa-camera"></i> หน้าถ่ายรูป</h3>
                </header>
                
                <div class="card-body">
                    <div class="usage-display">
                        <div class="progress-bar">
                            <div class="progress-fill" data-type="capture" 
                                 style="width: {{ (active_capture|default(0) / settings.max_capture_devices * 100) if settings.max_capture_devices > 0 else 0 }}%">
                            </div>
                        </div>
                        <div class="usage-text">
                            <span class="current-count">{{ active_capture|default(0) }}</span> / 
                            <span class="max-count">{{ settings.max_capture_devices|default(5) }}</span> 
                            <span class="unit">เครื่อง</span>
                        </div>
                    </div>
                    
                    <div class="device-settings">
                        <label for="maxCaptureDevices">
                            <i class="fas fa-sliders-h"></i> จำนวนเครื่องสูงสุด
                        </label>
                        <select id="maxCaptureDevices" class="setting-select">
                            <option value="1" {% if settings.max_capture_devices == 1 %}selected{% endif %}>1 เครื่อง</option>
                            <option value="2" {% if settings.max_capture_devices == 2 %}selected{% endif %}>2 เครื่อง</option>
                            <option value="3" {% if settings.max_capture_devices == 3 %}selected{% endif %}>3 เครื่อง</option>
                            <option value="5" {% if settings.max_capture_devices == 5 %}selected{% endif %}>5 เครื่อง</option>
                            <option value="10" {% if settings.max_capture_devices == 10 %}selected{% endif %}>10 เครื่อง</option>
                            <option value="999" {% if settings.max_capture_devices == 999 %}selected{% endif %}>ไม่จำกัด</option>
                        </select>
                    </div>

                    <div class="action-buttons">
                        <button onclick="DeviceManager.saveLimits()" class="btn btn-primary">
                            <i class="fas fa-save"></i> บันทึก
                        </button>
                        <button onclick="DeviceManager.kickAll('capture')" class="btn btn-warning">
                            <i class="fas fa-sign-out-alt"></i> ไล่ออก
                        </button>
                    </div>

                    <div id="captureSessionList" class="session-list"></div>
                </div>
            </article>

            <!-- QR Display Devices -->
            <article class="device-card">
                <header class="card-header">
                    <h3><i class="fas fa-qrcode"></i> หน้าแสดง QR</h3>
                </header>
                
                <div class="card-body">
                    <div class="usage-display">
                        <div class="progress-bar">
                            <div class="progress-fill" data-type="qr" 
                                 style="width: {{ (active_qr|default(0) / settings.max_qr_devices * 100) if settings.max_qr_devices > 0 else 0 }}%">
                            </div>
                        </div>
                        <div class="usage-text">
                            <span class="current-count">{{ active_qr|default(0) }}</span> / 
                            <span class="max-count">{{ settings.max_qr_devices|default(3) }}</span> 
                            <span class="unit">เครื่อง</span>
                        </div>
                    </div>
                    
                    <div class="device-settings">
                        <label for="maxQrDevices">
                            <i class="fas fa-sliders-h"></i> จำนวนเครื่องสูงสุด
                        </label>
                        <select id="maxQrDevices" class="setting-select">
                            <option value="1" {% if settings.max_qr_devices|int == 1 %}selected{% endif %}>1 เครื่อง</option>
                            <option value="2" {% if settings.max_qr_devices == 2 %}selected{% endif %}>2 เครื่อง</option>
                            <option value="3" {% if settings.max_qr_devices == 3 %}selected{% endif %}>3 เครื่อง</option>
                            <option value="5" {% if settings.max_qr_devices == 5 %}selected{% endif %}>5 เครื่อง</option>
                            <option value="10" {% if settings.max_qr_devices == 10 %}selected{% endif %}>10 เครื่อง</option>
                            <option value="999" {% if settings.max_qr_devices == 999 %}selected{% endif %}>ไม่จำกัด</option>
                        </select>
                    </div>

                    <div class="action-buttons">
                        <button onclick="DeviceManager.saveLimits()" class="btn btn-primary">
                            <i class="fas fa-save"></i> บันทึก
                        </button>
                        <button onclick="DeviceManager.kickAll('qr')" class="btn btn-warning">
                            <i class="fas fa-sign-out-alt"></i> ไล่ออก
                        </button>
                    </div>

                    <div id="qrSessionList" class="session-list"></div>
                </div>
            </article>

            <!-- Session Management -->
            <article class="device-card">
                <header class="card-header">
                    <h3><i class="fas fa-users-cog"></i> จัดการ Session</h3>
                </header>
                
                <div class="card-body">
                    <div class="info-panel">
                        <p><i class="fas fa-info-circle"></i> Session หมดอายุอัตโนมัติหลัง 30 นาที</p>
                        <p><i class="fas fa-sync"></i> ระบบตรวจสอบและล้างอัตโนมัติ</p>
                    </div>
                    
                    <div class="session-stats">
                        <div class="stat-item">
                            <i class="fas fa-camera"></i>
                            <span>Capture: <strong id="captureCount">{{ active_capture|default(0) }}</strong></span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-qrcode"></i>
                            <span>QR: <strong id="qrCount">{{ active_qr|default(0) }}</strong></span>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button onclick="SessionManager.refresh()" class="btn btn-info">
                            <i class="fas fa-sync"></i> รีเฟรช
                        </button>
                        <button onclick="SessionManager.clearAll()" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i> ล้างทั้งหมด
                        </button>
                    </div>
                </div>
            </article>
        </div>
    </section>

    <!-- Camera Control Section -->
    <section class="control-section">
        <h2 class="section-title">
            <i class="fas fa-gamepad"></i> การควบคุมระบบ
        </h2>
        
        <div class="control-grid">
            <!-- Camera Lock Control -->
            <div class="control-card">
                <h3><i class="fas fa-lock"></i> การล็อคเครื่องถ่ายรูป</h3>
                <div class="control-status">
                    {% if camera_locked %}
                    <div class="status-badge status-locked">
                        <i class="fas fa-lock"></i> ถูกล็อค
                    </div>
                    <div class="status-info">
                        <p><strong>รหัสที่ล็อค:</strong> {{ locked_by_code|default('-') }}</p>
                        <p><strong>สถานะ:</strong> รอการสแกนรับรูป</p>
                    </div>
                    <div class="control-buttons">
                        <button onclick="unlockCamera()" class="btn btn-success">
                            <i class="fas fa-unlock"></i> ปลดล็อคเครื่อง
                        </button>
                        <button onclick="forceUnlock()" class="btn btn-warning">
                            <i class="fas fa-bolt"></i> ปลดล็อคทันที
                        </button>
                    </div>
                    {% else %}
                    <div class="status-badge status-unlocked">
                        <i class="fas fa-unlock"></i> ไม่ถูกล็อค
                    </div>
                    <div class="status-info">
                        <p><strong>สถานะ:</strong> พร้อมใช้งาน</p>
                        <p><strong>ผู้ใช้:</strong> สามารถถ่ายรูปได้</p>
                    </div>
                    <div class="control-buttons">
                        <button onclick="lockCameraTest()" class="btn btn-info">
                            <i class="fas fa-vial"></i> ทดสอบล็อค
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- QR Control -->
            <div class="control-card">
                <h3><i class="fas fa-qrcode"></i> จัดการ QR ล่าสุด</h3>
                <div class="control-status">
                    {% if latest_qr and latest_qr.qr_image %}
                    <div class="qr-preview-small">
                        <img src="{{ latest_qr.qr_image }}" alt="QR Code" width="120">
                    </div>
                    <div class="status-info">
                        <p><strong>รหัส:</strong> {{ latest_qr.code }}</p>
                        <p><strong>เวลา:</strong> {{ latest_qr.time_display }}</p>
                    </div>
                    <div class="control-buttons">
                        <button onclick="clearQR()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> ล้าง QR
                        </button>
                        <button onclick="viewQR('{{ latest_qr.code }}')" class="btn btn-secondary">
                            <i class="fas fa-eye"></i> ดูหน้าแสดง
                        </button>
                    </div>
                    {% else %}
                    <div class="status-info empty">
                        <p><i class="fas fa-qrcode fa-2x"></i></p>
                        <p>ยังไม่มี QR ในระบบ</p>
                    </div>
                    <div class="control-buttons">
                        <button onclick="createTestQR()" class="btn btn-info">
                            <i class="fas fa-plus"></i> สร้างทดสอบ
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- System Control -->
            <div class="control-card">
                <h3><i class="fas fa-sliders-h"></i> การตั้งค่าระบบ</h3>
                <div class="control-status">
                    <div class="setting-item">
                        <label><i class="fas fa-camera"></i> จำกัดการถ่ายใหม่:</label>
                        <select id="retakeLimit" class="setting-select">
                            <option value="1" {% if settings.retake_limit == 1 %}selected{% endif %}>1 ครั้ง</option>
                            <option value="0" {% if settings.retake_limit == 0 %}selected{% endif %}>ไม่ให้ถ่ายใหม่</option>
                            <option value="2" {% if settings.retake_limit == 2 %}selected{% endif %}>2 ครั้ง</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label><i class="fas fa-image"></i> จำนวนรูปสูงสุด:</label>
                        <select id="maxPhotos" class="setting-select">
                            <option value="1" {% if settings.max_photos == 1 %}selected{% endif %}>1 รูป</option>
                            <option value="2" {% if settings.max_photos == 2 %}selected{% endif %}>2 รูป</option>
                            <option value="3" {% if settings.max_photos == 3 %}selected{% endif %}>3 รูป</option>
                            <option value="4" {% if settings.max_photos == 4 %}selected{% endif %}>4 รูป</option>
                        </select>
                    </div>
                    <div class="control-buttons">
                        <button onclick="saveSettings()" class="btn btn-primary">
                            <i class="fas fa-save"></i> บันทึกการตั้งค่า
                        </button>
                        <button onclick="resetSettings()" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> รีเซ็ต
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Photos List Section -->
    <section class="photos-section">
        <div class="section-header">
            <h2><i class="fas fa-images"></i> รูปทั้งหมด</h2>
            <span class="section-badge">{{ photos|length if photos else 0 }} เซสชัน</span>
            <div class="section-actions">
                <button onclick="exportAllData()" class="btn btn-export">
                    <i class="fas fa-file-export"></i> Export ข้อมูล
                </button>
                <button onclick="refreshData()" class="btn btn-refresh">
                    <i class="fas fa-sync"></i> รีเฟรช
                </button>
            </div>
        </div>
        
        {% if photos and photos|length > 0 %}
        <div class="table-responsive">
            <table class="photos-table">
                <thead>
                    <tr>
                        <th>รหัส</th>
                        <th>รูปตัวอย่าง</th>
                        <th>เวลา</th>
                        <th>รูป</th>
                        <th>ดาวน์โหลด</th>
                        <th>ถ่ายใหม่</th>
                        <th>จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for photo in photos %}
                    <tr>
                        <td>
                            <div class="code-cell">
                                <code>{{ photo.pickup_code }}</code>
                                <button onclick="copyCode('{{ photo.pickup_code }}')" class="copy-btn" title="คัดลอกรหัส">
                                    <i class="far fa-copy"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            {% if photo.filenames and photo.filenames|length > 0 %}
                            <div class="thumbnail-container">
                                <img src="{{ url_for('get_photo', filename=photo.filenames[0]) }}" 
                                     class="thumbnail" 
                                     alt="Thumbnail"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSIzMCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzdFODA5NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='">
                                <div class="thumbnail-overlay">
                                    <span>{{ photo.filenames|length }}</span>
                                </div>
                            </div>
                            {% else %}
                            <div class="no-thumb">ไม่มีรูป</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="time-cell">
                                <div class="time-main">{{ photo.time_display if photo.time_display else '-' }}</div>
                                <div class="time-sub">{{ photo.timestamp[:10] if photo.timestamp else '' }}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-info">{{ photo.filenames|length if photo.filenames else 0 }}</span>
                        </td>
                        <td>
                            <span class="badge badge-success">{{ photo.download_count if photo.download_count else 0 }}</span>
                        </td>
                        <td>
                            {% if photo.retake_used %}
                            <span class="badge badge-warning">
                                <i class="fas fa-check"></i> ใช้แล้ว
                            </span>
                            {% else %}
                            <span class="badge badge-secondary">
                                <i class="fas fa-times"></i> ยังไม่ใช้
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="deletePhoto('{{ photo.pickup_code }}')" 
                                        class="btn-icon btn-delete" title="ลบรูป">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <a href="/download/{{ photo.pickup_code }}" 
                                   target="_blank" 
                                   class="btn-icon btn-view" title="ดูรูป">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="/scan/{{ photo.pickup_code }}" 
                                   target="_blank" 
                                   class="btn-icon btn-scan" title="สแกน QR">
                                    <i class="fas fa-qrcode"></i>
                                </a>
                                <button onclick="downloadPhotoZip('{{ photo.pickup_code }}')" 
                                        class="btn-icon btn-download" title="ดาวน์โหลด ZIP">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-footer">
            <div class="pagination-info">
                แสดงทั้งหมด {{ photos|length }} รายการ
            </div>
            <div class="table-actions">
                <button onclick="clearAllPhotos()" class="btn btn-danger btn-sm">
                    <i class="fas fa-broom"></i> ล้างรูปทั้งหมด
                </button>
                <button onclick="backupPhotos()" class="btn btn-secondary btn-sm">
                    <i class="fas fa-save"></i> Backup
                </button>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-images fa-3x"></i>
            </div>
            <h3>ยังไม่มีรูปในระบบ</h3>
            <p>ไปที่หน้า <a href="/capture" class="link">Camera</a> เพื่อถ่ายรูปแรก</p>
            <button onclick="createSampleData()" class="btn btn-info">
                <i class="fas fa-magic"></i> สร้างข้อมูลตัวอย่าง
            </button>
        </div>
        {% endif %}
    </section>

    <!-- System Information -->
    <section class="system-info-section">
        <h2 class="section-title">
            <i class="fas fa-info-circle"></i> ข้อมูลระบบ
        </h2>
        
        <div class="info-grid">
            <div class="info-card">
                <h3><i class="fas fa-link"></i> ลิงค์ระบบ</h3>
                <div class="info-links">
                    <a href="/capture" target="_blank" class="info-link">
                        <i class="fas fa-camera"></i> เครื่องถ่ายรูป
                        <span>/capture</span>
                    </a>
                    <a href="/qr" target="_blank" class="info-link">
                        <i class="fas fa-qrcode"></i> เครื่องแสดง QR
                        <span>/qr</span>
                    </a>
                    <a href="/admin" class="info-link">
                        <i class="fas fa-cog"></i> หน้าแอดมิน
                        <span>/admin</span>
                    </a>
                    <a href="/api/status" target="_blank" class="info-link">
                        <i class="fas fa-heartbeat"></i> API Status
                        <span>/api/status</span>
                    </a>
                </div>
            </div>
            
            <div class="info-card">
                <h3><i class="fas fa-chart-line"></i> สถิติระบบ</h3>
                <div class="system-stats">
                    <div class="system-stat">
                        <span>อัพโหลดล่าสุด:</span>
                        <span id="lastUploadTime">-</span>
                    </div>
                    <div class="system-stat">
                        <span>QR ล่าสุด:</span>
                        <span id="lastQRTime">{{ latest_qr.time_display if latest_qr else '-' }}</span>
                    </div>
                    <div class="system-stat">
                        <span>สถานะกล้อง:</span>
                        <span id="cameraStatusLive" class="status-indicator {% if camera_locked %}status-locked{% else %}status-unlocked{% endif %}">
                            {% if camera_locked %}
                            <i class="fas fa-lock"></i> ล็อค
                            {% else %}
                            <i class="fas fa-unlock"></i> ปลดล็อค
                            {% endif %}
                        </span>
                    </div>
                    <div class="system-stat">
                        <span>เวลาปัจจุบัน:</span>
                        <span id="currentTime">--:--:--</span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3><i class="fas fa-tools"></i> เครื่องมือระบบ</h3>
                <div class="tool-buttons">
                    <button onclick="restartCamera()" class="btn-tool">
                        <i class="fas fa-redo"></i> รีสตาร์ทกล้อง
                    </button>
                    <button onclick="clearCache()" class="btn-tool">
                        <i class="fas fa-broom"></i> ล้างแคช
                    </button>
                    <button onclick="checkDiskSpace()" class="btn-tool">
                        <i class="fas fa-hdd"></i> ตรวจสอบพื้นที่
                    </button>
                    <button onclick="viewLogs()" class="btn-tool">
                        <i class="fas fa-file-alt"></i> ดู Logs
                    </button>
                    <button onclick="systemDiagnostic()" class="btn-tool">
                        <i class="fas fa-stethoscope"></i> วินิจฉัยระบบ
                    </button>
                    <button onclick="emergencyUnlock()" class="btn-tool btn-emergency">
                        <i class="fas fa-exclamation-triangle"></i> ปลดล็อคฉุกเฉิน
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions">
        <h3><i class="fas fa-bolt"></i> การดำเนินการด่วน</h3>
        <div class="action-buttons-grid">
            <button onclick="quickUnlock()" class="btn-quick-action">
                <i class="fas fa-unlock"></i>
                <span>ปลดล็อคเครื่อง</span>
            </button>
            <button onclick="quickClearQR()" class="btn-quick-action">
                <i class="fas fa-trash"></i>
                <span>ล้าง QR</span>
            </button>
            <button onclick="quickRefresh()" class="btn-quick-action">
                <i class="fas fa-sync"></i>
                <span>รีเฟรชหน้า</span>
            </button>
            <button onclick="quickStats()" class="btn-quick-action">
                <i class="fas fa-chart-bar"></i>
                <span>อัปเดตสถิติ</span>
            </button>
            <button onclick="quickBackup()" class="btn-quick-action">
                <i class="fas fa-save"></i>
                <span>Backup ข้อมูล</span>
            </button>
            <button onclick="quickTest()" class="btn-quick-action">
                <i class="fas fa-vial"></i>
                <span>ทดสอบระบบ</span>
            </button>
        </div>
    </section>
</div>

<!-- Modal -->
<div id="infoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle"></h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button onclick="closeModal()" class="btn btn-secondary">ปิด</button>
        </div>
    </div>
</div>

<style>
/* ============================================
   Main Layout
============================================ */
.admin-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    background: #f7fafc;
    min-height: 100vh;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title i {
    color: #667eea;
}

/* ============================================
   Header
============================================ */
.admin-header {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.admin-header h1 {
    font-size: 2.5rem;
    margin: 0 0 10px 0;
    color: white;
}

.admin-header .subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
}

.server-info {
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: wrap;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.info-item {
    background: rgba(255,255,255,0.1);
    padding: 8px 15px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: monospace;
    font-size: 0.9rem;
}

/* ============================================
   Status Grid
============================================ */
.status-grid,
.stats-grid,
.device-grid,
.control-grid,
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.status-card {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.3s, box-shadow 0.3s;
}

.status-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.status-card.status-online { border-left: 4px solid #48bb78; }
.status-card.status-locked { border-left: 4px solid #f56565; }
.status-card.status-unlocked { border-left: 4px solid #48bb78; }
.status-card.status-active { border-left: 4px solid #ed8936; }
.status-card.status-normal { border-left: 4px solid #667eea; }

.status-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #667eea;
}

.status-card.status-online .status-icon { color: #48bb78; }
.status-card.status-locked .status-icon { color: #f56565; }
.status-card.status-unlocked .status-icon { color: #48bb78; }
.status-card.status-active .status-icon { color: #ed8936; }

.status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    margin-top: 0.5rem;
}

.status-online .status-badge { background: #c6f6d5; color: #22543d; }
.status-locked .status-badge { background: #fed7d7; color: #742a2a; }
.status-unlocked .status-badge { background: #c6f6d5; color: #22543d; }
.status-active .status-badge { background: #feebc8; color: #744210; }
.status-normal .status-badge { background: #e9d8fd; color: #44337a; }

/* ============================================
   Stat Cards
============================================ */
.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
}

.stat-icon {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.8rem;
}

.stat-content h3 {
    color: #718096;
    font-size: 0.9rem;
    margin: 0 0 5px 0;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.stat-number {
    font-size: 2.2rem;
    font-weight: 700;
    color: #2d3748;
    line-height: 1;
    margin-bottom: 5px;
}

.stat-sub {
    color: #a0aec0;
    font-size: 0.85rem;
}

/* ============================================
   Device Cards
============================================ */
.device-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    overflow: hidden;
}

.card-header {
    background: linear-gradient(135deg, #f7fafc, #edf2f7);
    padding: 1.5rem;
    border-bottom: 2px solid #e2e8f0;
}

.card-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #2d3748;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.card-body {
    padding: 1.5rem;
}

.usage-display {
    margin-bottom: 1.5rem;
}

.progress-bar {
    width: 100%;
    height: 30px;
    background: #e2e8f0;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 0.75rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #48bb78, #38a169);
    border-radius: 15px;
    transition: width 0.5s ease;
}

.progress-fill[data-type="qr"] {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.usage-text {
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
}

.current-count {
    color: #667eea;
    font-size: 1.8rem;
}

.max-count {
    color: #a0aec0;
    font-size: 1.2rem;
}

.unit {
    color: #a0aec0;
    font-size: 0.9rem;
    margin-left: 0.25rem;
}

.device-settings {
    margin-bottom: 1.5rem;
}

.device-settings label {
    display: block;
    margin-bottom: 0.5rem;
    color: #4a5568;
    font-weight: 600;
}

.setting-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.3s;
}

.setting-select:focus {
    outline: none;
    border-color: #667eea;
}

/* ============================================
   Control Cards
============================================ */
.control-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.control-card h3 {
    color: #2d3748;
    margin: 0 0 20px 0;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.control-status {
    text-align: center;
}

.control-status .status-badge {
    margin-bottom: 15px;
}

.status-info {
    margin-bottom: 20px;
    color: #4a5568;
}

.status-info p {
    margin: 8px 0;
}

.status-info.empty {
    padding: 20px;
    color: #a0aec0;
}

.control-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.setting-item label {
    color: #4a5568;
    font-weight: 500;
    font-size: 0.95rem;
}

/* ============================================
   Tables
============================================ */
.photos-section {
    background: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
    flex-wrap: wrap;
    gap: 15px;
}

.section-header h2 {
    color: #2d3748;
    font-size: 1.5rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-badge {
    background: #e2e8f0;
    padding: 5px 15px;
    border-radius: 20px;
    color: #4a5568;
    font-weight: 600;
    font-size: 0.9rem;
}

.section-actions {
    display: flex;
    gap: 10px;
}

.table-responsive {
    overflow-x: auto;
    margin: 20px 0;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

.photos-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.photos-table th {
    background: #f7fafc;
    padding: 15px;
    text-align: left;
    color: #4a5568;
    font-weight: 600;
    border-bottom: 2px solid #e2e8f0;
    white-space: nowrap;
}

.photos-table td {
    padding: 15px;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.photos-table tr:hover {
    background: #f7fafc;
}

.code-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.code-cell code {
    background: #e2e8f0;
    padding: 5px 10px;
    border-radius: 5px;
    font-family: monospace;
    font-size: 0.85rem;
    color: #2d3748;
}

.copy-btn {
    background: none;
    border: none;
    color: #667eea;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: background 0.3s;
}

.copy-btn:hover {
    background: #edf2f7;
}

.thumbnail-container {
    position: relative;
    width: 60px;
    height: 60px;
}

.thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
}

.thumbnail-overlay {
    position: absolute;
    bottom: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
}

.no-thumb {
    width: 60px;
    height: 60px;
    background: #e2e8f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #a0aec0;
    font-size: 0.75rem;
}

.time-cell {
    min-width: 120px;
}

.time-main {
    font-weight: 500;
    color: #2d3748;
}

.time-sub {
    font-size: 0.8rem;
    color: #a0aec0;
}

.badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.badge-info {
    background: #bee3f8;
    color: #2c5282;
}

.badge-success {
    background: #c6f6d5;
    color: #22543d;
}

.badge-warning {
    background: #feebc8;
    color: #744210;
}

.badge-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-icon {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.btn-delete {
    background: #fed7d7;
    color: #742a2a;
}

.btn-view {
    background: #bee3f8;
    color: #2c5282;
}

.btn-scan {
    background: #c6f6d5;
    color: #22543d;
}

.btn-download {
    background: #e9d8fd;
    color: #553c9a;
}

.btn-icon:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
    flex-wrap: wrap;
    gap: 15px;
}

.pagination-info {
    color: #718096;
    font-size: 0.9rem;
}

.table-actions {
    display: flex;
    gap: 10px;
}

/* ============================================
   Empty State
============================================ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
}

.empty-icon {
    margin-bottom: 20px;
    opacity: 0.3;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: #4a5568;
    font-size: 1.3rem;
}

.empty-state p {
    margin-bottom: 25px;
}

.link {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
}

.link:hover {
    text-decoration: underline;
}

/* ============================================
   System Info
============================================ */
.system-info-section {
    background: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
}

.info-card {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.info-card h3 {
    color: #2d3748;
    margin: 0 0 20px 0;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.info-links {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.info-link {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: white;
    border-radius: 8px;
    text-decoration: none;
    color: #4a5568;
    border: 1px solid #e2e8f0;
    transition: all 0.3s;
}

.info-link:hover {
    background: #667eea;
    color: white;
    transform: translateX(5px);
}

.info-link span {
    font-family: monospace;
    font-size: 0.8rem;
    opacity: 0.7;
}

.system-stats {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.system-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.system-stat span:first-child {
    color: #718096;
    font-weight: 500;
}

.system-stat span:last-child {
    color: #2d3748;
    font-weight: 600;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.status-indicator.status-locked {
    background: #fed7d7;
    color: #742a2a;
}

.status-indicator.status-unlocked {
    background: #c6f6d5;
    color: #22543d;
}

.tool-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.btn-tool {
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: white;
    color: #4a5568;
    cursor: pointer;
    font-size: 0.9rem;
    text-align: left;
    border: 1px solid #e2e8f0;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-tool:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.btn-emergency {
    grid-column: span 2;
    background: #fed7d7;
    color: #742a2a;
    border-color: #fc8181;
}

.btn-emergency:hover {
    background: #f56565;
    color: white;
}

/* ============================================
   Quick Actions
============================================ */
.quick-actions {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
}

.quick-actions h3 {
    color: #2d3748;
    margin: 0 0 20px 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-buttons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.btn-quick-action {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 15px;
    border: none;
    border-radius: 12px;
    background: #f8f9fa;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid #e2e8f0;
}

.btn-quick-action:hover {
    background: #667eea;
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(102,126,234,0.3);
}

.btn-quick-action i {
    font-size: 1.8rem;
    margin-bottom: 10px;
}

.btn-quick-action span {
    font-size: 0.9rem;
    font-weight: 500;
    text-align: center;
}

/* ============================================
   Buttons
============================================ */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-success {
    background: #48bb78;
    color: white;
}

.btn-danger {
    background: #f56565;
    color: white;
}

.btn-warning {
    background: #ed8936;
    color: white;
}

.btn-info {
    background: #4299e1;
    color: white;
}

.btn-secondary {
    background: #a0aec0;
    color: white;
}

.btn-export {
    background: #9f7aea;
    color: white;
}

.btn-refresh {
    background: #4299e1;
    color: white;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* ============================================
   Modal
============================================ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(3px);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 20px 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.3rem;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.3s;
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 30px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 20px 30px;
    background: #f8f9fa;
    border-radius: 0 0 15px 15px;
    text-align: right;
    border-top: 1px solid #e2e8f0;
}

/* ============================================
   Messages
============================================ */
.message {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 10px;
    color: white;
    font-weight: 500;
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    animation: messageSlideIn 0.3s ease;
    max-width: 400px;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.message-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
}

.message-error {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
}

.message-info {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
}

/* ============================================
   Responsive
============================================ */
@media (max-width: 1024px) {
    .admin-header h1 {
        font-size: 2rem;
    }
    
    .status-grid,
    .stats-grid,
    .device-grid,
    .control-grid,
    .info-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .admin-page {
        padding: 10px;
    }
    
    .admin-header {
        padding: 20px;
    }
    
    .admin-header h1 {
        font-size: 1.6rem;
    }
    
    .status-grid,
    .stats-grid,
    .device-grid,
    .control-grid,
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .section-actions {
        width: 100%;
        flex-wrap: wrap;
    }
    
    .action-buttons {
        flex-wrap: wrap;
    }
    
    .btn {
        width: 100%;
    }
    
    .tool-buttons {
        grid-template-columns: 1fr;
    }
    
    .btn-emergency {
        grid-column: 1;
    }
    
    .action-buttons-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
}

@media (max-width: 480px) {
    .admin-header h1 {
        font-size: 1.4rem;
    }
    
    .server-info {
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }
    
    .stat-card {
        flex-direction: column;
        text-align: center;
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .stat-number {
        font-size: 1.8rem;
    }
    
    .action-buttons-grid {
        grid-template-columns: 1fr;
    }
    
    .table-footer {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .table-actions {
        width: 100%;
        flex-direction: column;
    }
    
    .modal-header {
        padding: 15px 20px;
    }
    
    .modal-body {
        padding: 20px;
    }
}
</style>

<script>
// ============================================
// Device Management
// ============================================
const DeviceManager = {
    async saveLimits() {
        const maxCapture = parseInt(document.getElementById('maxCaptureDevices').value);
        const maxQr = parseInt(document.getElementById('maxQrDevices').value);
        
        try {
            const response = await fetch('/api/save_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    max_capture_devices: maxCapture,
                    max_qr_devices: maxQr
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('💾 บันทึกการตั้งค่าเรียบร้อย', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('❌ เกิดข้อผิดพลาด: ' + (data.error || 'ไม่ทราบสาเหตุ'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('❌ ไม่สามารถบันทึกได้', 'error');
        }
    },

    async kickAll(type) {
        const typeName = type === 'capture' ? 'หน้าถ่ายรูป' : 'หน้าแสดง QR';
        
        if (!confirm(`ต้องการไล่เครื่องทั้งหมดออกจาก${typeName}หรือไม่?`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/clear_all_sessions', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('✅ ไล่ออกทั้งหมดเรียบร้อย', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('❌ เกิดข้อผิดพลาด: ' + (data.error || 'ไม่ทราบสาเหตุ'), 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('❌ ไม่สามารถดำเนินการได้', 'error');
        }
    }
};

// ============================================
// Session Management
// ============================================
const SessionManager = {
    async refresh() {
        try {
            const response = await fetch('/api/session_status');
            const data = await response.json();
            
            document.getElementById('captureCount').textContent = data.capture?.active || 0;
            document.getElementById('qrCount').textContent = data.qr?.active || 0;
            
            const captureFill = document.querySelector('[data-type="capture"]');
            const qrFill = document.querySelector('[data-type="qr"]');
            
            if (captureFill && data.capture?.max > 0) {
                captureFill.style.width = (data.capture.active / data.capture.max * 100) + '%';
            }
            
            if (qrFill && data.qr?.max > 0) {
                qrFill.style.width = (data.qr.active / data.qr.max * 100) + '%';
            }
            
            showMessage('🔄 รีเฟรชข้อมูลเรียบร้อย', 'success');
        } catch (error) {
            console.error('Error:', error);
            showMessage('⚠️ ไม่สามารถรีเฟรชข้อมูลได้', 'info');
        }
    },

    async clearAll() {
        if (!confirm('⚠️ ต้องการล้าง Session ทั้งหมดหรือไม่?\n\nเครื่องทั้งหมดจะถูกไล่ออก!')) {
            return;
        }
        
        try {
            const response = await fetch('/api/clear_all_sessions', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('🗑️ ล้าง Session ทั้งหมดเรียบร้อย', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('❌ ไม่สามารถล้างได้', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('❌ ไม่สามารถล้างได้', 'error');
        }
    }
};

// ============================================
// Camera Control Functions
// ============================================
function unlockCamera() {
    if (confirm('ยืนยันการปลดล็อคเครื่องถ่ายรูป?\nเครื่องจะสามารถถ่ายรูปได้ทันที')) {
        fetch('/api/unlock_camera', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('ปลดล็อคเครื่องถ่ายรูปเรียบร้อยแล้ว', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage('ไม่สามารถปลดล็อคได้: ' + (data.error || 'ไม่ทราบสาเหตุ'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
            });
    }
}

function forceUnlock() {
    if (confirm('⚠️ ต้องการปลดล็อคทันทีโดยไม่ต้องสแกน QR?\nการกระทำนี้อาจทำให้ผู้ใช้ไม่สามารถรับรูปได้')) {
        fetch('/api/unlock_camera', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('ปลดล็อคฉุกเฉินสำเร็จ', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('เกิดข้อผิดพลาด', 'error');
            });
    }
}

function lockCameraTest() {
    showModal('ทดสอบล็อคเครื่อง', `
        <p>ฟังก์ชันนี้ใช้สำหรับทดสอบระบบล็อคเครื่อง</p>
        <p>ระบบจะสร้างรูปทดสอบและล็อคเครื่องชั่วคราว</p>
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="createTestLock()" class="btn btn-info" style="font-size: 1rem; padding: 12px 25px;">
                <i class="fas fa-vial"></i> ดำเนินการทดสอบ
            </button>
        </div>
    `);
}

function createTestLock() {
    showMessage('⚠️ API ทดสอบต้องตั้งค่าเพิ่มเติม', 'info');
    closeModal();
}

// ============================================
// QR Control Functions
// ============================================
function clearQR() {
    if (confirm('ยืนยันการล้าง QR ล่าสุด?\nQR บนจอแสดงจะหายไป')) {
        fetch('/api/clear_qr', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('ล้าง QR ล่าสุดเรียบร้อยแล้ว', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage('ไม่สามารถล้าง QR ได้', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('เกิดข้อผิดพลาด', 'error');
            });
    }
}

function viewQR(code) {
    window.open(`/scan/${code}`, '_blank');
}

function createTestQR() {
    showMessage('⚠️ API สร้าง QR ทดสอบต้องตั้งค่าเพิ่มเติม', 'info');
}

// ============================================
// Photo Management Functions
// ============================================
function deletePhoto(code) {
    if (confirm(`ยืนยันการลบรูปรหัส ${code}?\nการกระทำนี้ไม่สามารถย้อนกลับได้`)) {
        fetch(`/api/delete/${code}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`ลบรูป ${code} เรียบร้อย`, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage('ลบไม่สำเร็จ: ' + (data.error || 'ไม่ทราบสาเหตุ'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
            });
    }
}

function downloadPhotoZip(code) {
    window.open(`/api/download_all/${code}`, '_blank');
}

function clearAllPhotos() {
    if (confirm('⚠️ ต้องการลบรูปทั้งหมดใช่หรือไม่?\nการกระทำนี้จะลบทุกรูปและสถิติ!\nไม่สามารถย้อนกลับได้!')) {
        if (prompt('พิมพ์ "DELETE ALL PHOTOS" เพื่อยืนยัน:') === 'DELETE ALL PHOTOS') {
            fetch('/api/clear_all_photos', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('ลบรูปทั้งหมดเรียบร้อยแล้ว', 'success');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('ไม่สามารถลบรูปทั้งหมดได้', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('เกิดข้อผิดพลาด', 'error');
                });
        }
    }
}

function backupPhotos() {
    showModal('Backup ข้อมูล', `
        <p>ระบบจะสร้างไฟล์ Backup ข้อมูลทั้งหมด</p>
        <div class="backup-options" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px;">
            <button onclick="exportJSON()" class="btn btn-secondary">
                <i class="fas fa-file-code"></i> Export JSON
            </button>
            <button onclick="exportCSV()" class="btn btn-secondary">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
        </div>
    `);
}

function exportJSON() {
    window.open('/api/admin_data', '_blank');
    closeModal();
}

function exportCSV() {
    showMessage('⚠️ API Export CSV ต้องตั้งค่าเพิ่มเติม', 'info');
    closeModal();
}

// ============================================
// System Functions
// ============================================
function saveSettings() {
    const retakeLimit = document.getElementById('retakeLimit').value;
    const maxPhotos = document.getElementById('maxPhotos').value;
    
    fetch('/api/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            retake_limit: parseInt(retakeLimit),
            max_photos: parseInt(maxPhotos)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('บันทึกการตั้งค่าเรียบร้อยแล้ว', 'success');
        } else {
            showMessage('บันทึกไม่สำเร็จ: ' + (data.error || 'ไม่ทราบสาเหตุ'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('เกิดข้อผิดพลาดในการบันทึก', 'error');
    });
}

function resetSettings() {
    document.getElementById('retakeLimit').value = '1';
    document.getElementById('maxPhotos').value = '3';
    showMessage('รีเซ็ตการตั้งค่าเป็นค่าเริ่มต้นแล้ว', 'success');
}

function restartCamera() {
    showMessage('⚠️ API รีสตาร์ทกล้องต้องตั้งค่าเพิ่มเติม', 'info');
}

function checkDiskSpace() {
    fetch('/api/system_info')
        .then(response => response.json())
        .then(data => {
            if (data.disk_percent) {
                showModal('พื้นที่ดิสก์', `
                    <div class="disk-info">
                        <div class="disk-usage" style="margin-bottom: 20px;">
                            <div class="progress-bar" style="margin-bottom: 10px;">
                                <div class="progress-fill" style="width: ${data.disk_percent}%; background: #4299e1;"></div>
                            </div>
                            <div style="text-align: center; font-size: 1.5rem; font-weight: 700; color: #2d3748;">
                                ${data.disk_percent}%
                            </div>
                        </div>
                        <div class="disk-stats">
                            <p><strong>ใช้ไป:</strong> ${data.disk_used_gb || 'N/A'} GB</p>
                            <p><strong>คงเหลือ:</strong> ${data.disk_free_gb || 'N/A'} GB</p>
                            <p><strong>ทั้งหมด:</strong> ${data.disk_total_gb || 'N/A'} GB</p>
                        </div>
                    </div>
                `);
            } else {
                showMessage('ไม่สามารถดึงข้อมูลพื้นที่ดิสก์ได้', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('ไม่สามารถตรวจสอบพื้นที่ดิสก์ได้', 'error');
        });
}

function systemDiagnostic() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            showModal('วินิจฉัยระบบ', `
                <div class="diagnostic-info">
                    <p><strong>สถานะเซิร์ฟเวอร์:</strong> <span style="color: #48bb78;">${data.status || 'OK'}</span></p>
                    <p><strong>รูปทั้งหมด:</strong> ${data.total_photos || 0}</p>
                    <p><strong>เซสชันทั้งหมด:</strong> ${data.total_sessions || 0}</p>
                    <p><strong>ดาวน์โหลดทั้งหมด:</strong> ${data.total_downloads || 0}</p>
                    <p><strong>สถานะกล้อง:</strong> ${data.camera_locked ? 'ล็อค' : 'ปลดล็อค'}</p>
                    <p><strong>เวลาเซิร์ฟเวอร์:</strong> ${new Date(data.timestamp).toLocaleString('th-TH')}</p>
                </div>
            `);
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('ไม่สามารถวินิจฉัยระบบได้', 'error');
        });
}

function emergencyUnlock() {
    if (confirm('⚠️ EMERGENCY UNLOCK ⚠️\nต้องการปลดล็อคระบบฉุกเฉินทั้งหมดใช่หรือไม่?\nการกระทำนี้จะ:\n1. ปลดล็อคเครื่องถ่ายรูป\n2. ล้าง QR ล่าสุด\n3. รีเซ็ตระบบ')) {
        showMessage('⚠️ API ปลดล็อคฉุกเฉินต้องตั้งค่าเพิ่มเติม', 'info');
    }
}

// ============================================
// Quick Actions
// ============================================
function quickUnlock() {
    unlockCamera();
}

function quickClearQR() {
    clearQR();
}

function quickRefresh() {
    location.reload();
}

function quickStats() {
    SessionManager.refresh();
}

function quickBackup() {
    backupPhotos();
}

function quickTest() {
    showModal('ทดสอบระบบ', `
        <p>ฟังก์ชันทดสอบระบบ Photo Booth</p>
        <div style="text-align: center; margin: 20px 0;">
            <p><i class="fas fa-check-circle" style="color: #48bb78; font-size: 3rem;"></i></p>
            <p>ระบบพร้อมใช้งาน</p>
            <p style="color: #718096; font-size: 0.9rem; margin-top: 15px;">
                เบราว์เซอร์ที่แนะนำ: Chrome, Edge, Safari<br>
                รองรับ WebRTC ทุกรุ่น
            </p>
        </div>
    `);
}

// ============================================
// Export Functions
// ============================================
function exportAllData() {
    window.open('/api/admin_data', '_blank');
}

function refreshData() {
    location.reload();
}

function createSampleData() {
    if (confirm('สร้างข้อมูลตัวอย่าง?\nจะมีการเพิ่มรูปและสถิติเทียม')) {
        showMessage('⚠️ API สร้างข้อมูลตัวอย่างต้องตั้งค่าเพิ่มเติม', 'info');
    }
}

function clearCache() {
    if (confirm('ล้างแคชเบราว์เซอร์?\nอาจต้องล็อกอินใหม่ในบางหน้า')) {
        if (caches && caches.keys) {
            caches.keys().then(function(names) {
                for (let name of names) caches.delete(name);
                showMessage('ล้างแคชสำเร็จ', 'success');
            });
        } else {
            showMessage('เบราว์เซอร์ไม่รองรับการล้างแคช', 'info');
        }
    }
}

function viewLogs() {
    showMessage('⚠️ API ดู Logs ต้องตั้งค่าเพิ่มเติม', 'info');
}

// ============================================
// Utility Functions
// ============================================
function showMessage(text, type = 'info') {
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());
    
    const message = document.createElement('div');
    message.className = `message message-${type}`;
    
    let icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    
    message.innerHTML = `<i class="fas fa-${icon}"></i> ${text}`;
    document.body.appendChild(message);
    
    setTimeout(() => {
        message.style.opacity = '0';
        setTimeout(() => message.remove(), 500);
    }, 3000);
}

function showModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('infoModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('infoModal').style.display = 'none';
}

function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showMessage(`คัดลอกรหัส ${code} เรียบร้อย`, 'success');
    }).catch(() => {
        showMessage('ไม่สามารถคัดลอกรหัสได้', 'error');
    });
}

// ============================================
// Time Functions
// ============================================
function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH');
    const dateStr = now.toLocaleDateString('th-TH', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    const currentTimeEl = document.getElementById('currentTime');
    if (currentTimeEl) {
        currentTimeEl.textContent = timeStr;
    }
    
    const serverTimeEl = document.getElementById('serverTime');
    if (serverTimeEl) {
        serverTimeEl.textContent = `${dateStr} ${timeStr}`;
    }
}

// ============================================
// Initialize
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // อัปเดตเวลาปัจจุบัน
    updateTime();
    setInterval(updateTime, 1000);
    
    // ตั้งค่าการตรวจสอบสถานะอัตโนมัติ
    setInterval(() => {
        fetch('/api/camera_status')
            .then(response => response.json())
            .then(data => {
                const statusEl = document.getElementById('cameraStatusLive');
                if (statusEl) {
                    if (data.camera_locked) {
                        statusEl.className = 'status-indicator status-locked';
                        statusEl.innerHTML = '<i class="fas fa-lock"></i> ล็อค';
                    } else {
                        statusEl.className = 'status-indicator status-unlocked';
                        statusEl.innerHTML = '<i class="fas fa-unlock"></i> ปลดล็อค';
                    }
                }
            })
            .catch(error => console.error('Error fetching camera status:', error));
    }, 10000);
    
    // ปิด modal เมื่อกดนอก
    window.onclick = function(event) {
        const modal = document.getElementById('infoModal');
        if (event.target == modal) {
            closeModal();
        }
    };
    
    // รีเฟรชข้อมูล session อัตโนมัติ
    setInterval(() => {
        SessionManager.refresh();
    }, 30000);
});
</script>
{% endblock %}
