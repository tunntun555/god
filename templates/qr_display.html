{% extends "layout.html" %}

{% block title %}รับรูปของคุณ - Photo Booth{% endblock %}

{% block content %}
<div class="qr-page">

  <!-- Ambient background blobs -->
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>

  <!-- Top label -->
  <div class="top-label">
    <span class="dot-live"></span>
    <span>PHOTO BOOTH</span>
  </div>

  <!-- Main content -->
  <div class="main-wrap">

    <div class="headline">
      <h1>รับรูปของคุณ</h1>
      <p class="tagline">สแกน QR Code เพื่อดาวน์โหลดรูปฟรี</p>
    </div>

    <!-- QR card -->
    <div class="qr-card">
      <div class="qr-inner">
        <div id="qrCodeDisplay" class="qr-display-area">
          <div class="qr-loading">
            <div class="spinner"></div>
            <span>กำลังโหลด…</span>
          </div>
        </div>

        <!-- Corner accents -->
        <span class="corner tl"></span>
        <span class="corner tr"></span>
        <span class="corner bl"></span>
        <span class="corner br"></span>
      </div>

      <div class="code-badge" id="codeBadge">
        <span id="latestCode">— — — —</span>
      </div>
    </div>

    <!-- Steps -->
    <div class="steps">
      <div class="step">
        <div class="step-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <rect x="5" y="2" width="14" height="20" rx="2"/><circle cx="12" cy="17" r="1"/>
          </svg>
        </div>
        <span>เปิดกล้อง<br>มือถือ</span>
      </div>
      <div class="step-arrow">›</div>
      <div class="step">
        <div class="step-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
            <rect x="7" y="7" width="10" height="10" rx="1"/>
          </svg>
        </div>
        <span>สแกน<br>QR Code</span>
      </div>
      <div class="step-arrow">›</div>
      <div class="step">
        <div class="step-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M12 15V3m0 12-4-4m4 4 4-4M2 17l.621 2.485A2 2 0 0 0 4.561 21h14.878a2 2 0 0 0 1.94-1.515L22 17"/>
          </svg>
        </div>
        <span>ดาวน์โหลด<br>รูปได้เลย!</span>
      </div>
    </div>

    <!-- Timestamp -->
    <p class="timestamp-label" id="latestTime"></p>

  </div>

  <!-- Bottom pulse line -->
  <div class="pulse-bar"></div>
</div>


<style>
  /* ─── Reset & tokens ─────────────────────────────────────────── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:       #08090d;
    --surface:  #12141c;
    --surface2: #1c1f2e;
    --border:   rgba(255,255,255,0.07);
    --accent:   #5c6ef8;
    --accent2:  #a78bfa;
    --green:    #34d399;
    --text:     #f0f0f8;
    --muted:    rgba(240,240,248,0.45);
    --radius:   24px;
  }

  body { background: var(--bg); }

  /* ─── Page layout ────────────────────────────────────────────── */
  .qr-page {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    padding: 40px 20px;
    font-family: 'Noto Sans Thai', 'Segoe UI', sans-serif;
    color: var(--text);
  }

  /* ─── Ambient blobs ──────────────────────────────────────────── */
  .blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.18;
    pointer-events: none;
  }
  .blob-1 {
    width: 600px; height: 600px;
    background: radial-gradient(circle, #5c6ef8, transparent 70%);
    top: -200px; left: -200px;
    animation: drift1 18s ease-in-out infinite alternate;
  }
  .blob-2 {
    width: 500px; height: 500px;
    background: radial-gradient(circle, #a78bfa, transparent 70%);
    bottom: -150px; right: -150px;
    animation: drift2 22s ease-in-out infinite alternate;
  }
  .blob-3 {
    width: 350px; height: 350px;
    background: radial-gradient(circle, #34d399, transparent 70%);
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.07;
    animation: drift3 14s ease-in-out infinite alternate;
  }
  @keyframes drift1 { to { transform: translate(80px, 60px); } }
  @keyframes drift2 { to { transform: translate(-60px, -80px); } }
  @keyframes drift3 { to { transform: translate(-50%, -45%) scale(1.15); } }

  /* ─── Top label ──────────────────────────────────────────────── */
  .top-label {
    position: absolute;
    top: 28px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.25em;
    color: var(--muted);
    text-transform: uppercase;
  }
  .dot-live {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 0 0 var(--green);
    animation: pulse-dot 2s infinite;
  }
  @keyframes pulse-dot {
    0%   { box-shadow: 0 0 0 0 rgba(52,211,153,0.6); }
    70%  { box-shadow: 0 0 0 8px rgba(52,211,153,0); }
    100% { box-shadow: 0 0 0 0 rgba(52,211,153,0); }
  }

  /* ─── Headline ───────────────────────────────────────────────── */
  .main-wrap {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 32px;
    width: 100%;
    max-width: 480px;
  }
  .headline { text-align: center; }
  .headline h1 {
    font-size: clamp(2rem, 6vw, 3.2rem);
    font-weight: 800;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, #fff 30%, var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
    margin-bottom: 10px;
  }
  .tagline {
    font-size: clamp(0.95rem, 2.5vw, 1.1rem);
    color: var(--muted);
    letter-spacing: 0.02em;
  }

  /* ─── QR Card ────────────────────────────────────────────────── */
  .qr-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }
  .qr-inner {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.04),
      0 30px 80px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(255,255,255,0.06);
  }

  /* Corner accent marks */
  .corner {
    position: absolute;
    width: 20px; height: 20px;
    border-color: var(--accent);
    border-style: solid;
    border-width: 0;
  }
  .corner.tl { top: 10px; left: 10px; border-top-width: 2.5px; border-left-width: 2.5px; border-radius: 4px 0 0 0; }
  .corner.tr { top: 10px; right: 10px; border-top-width: 2.5px; border-right-width: 2.5px; border-radius: 0 4px 0 0; }
  .corner.bl { bottom: 10px; left: 10px; border-bottom-width: 2.5px; border-left-width: 2.5px; border-radius: 0 0 0 4px; }
  .corner.br { bottom: 10px; right: 10px; border-bottom-width: 2.5px; border-right-width: 2.5px; border-radius: 0 0 4px 0; }

  /* Scan animation overlay */
  .qr-inner::after {
    content: '';
    position: absolute;
    left: 24px; right: 24px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    top: 30%;
    border-radius: 2px;
    animation: scan-line 3s ease-in-out infinite;
    pointer-events: none;
  }
  @keyframes scan-line {
    0%   { top: 20%; opacity: 0; }
    20%  { opacity: 1; }
    80%  { opacity: 1; }
    100% { top: 80%; opacity: 0; }
  }

  /* QR display area */
  .qr-display-area {
    width: clamp(240px, 55vw, 360px);
    height: clamp(240px, 55vw, 360px);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .qr-display-area img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 12px;
    display: block;
    animation: fadeIn 0.4s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }

  /* Loading spinner */
  .qr-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    color: var(--muted);
    font-size: 0.9rem;
  }
  .spinner {
    width: 36px; height: 36px;
    border: 2.5px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    color: var(--muted);
    text-align: center;
  }
  .empty-state svg {
    width: 64px; height: 64px;
    opacity: 0.3;
  }
  .empty-state h3 { font-size: 1.1rem; font-weight: 600; }
  .empty-state p  { font-size: 0.85rem; opacity: 0.7; }

  /* Code badge */
  .code-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 50px;
    padding: 8px 22px;
    font-size: 1.05rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.18em;
    color: var(--accent2);
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  }

  /* ─── Steps ──────────────────────────────────────────────────── */
  .steps {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    text-align: center;
    font-size: 0.8rem;
    color: var(--muted);
    line-height: 1.4;
    max-width: 80px;
  }
  .step-icon {
    width: 52px; height: 52px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }
  .step-icon svg {
    width: 24px; height: 24px;
    stroke: var(--accent2);
  }
  .step:hover .step-icon {
    background: var(--accent);
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(92,110,248,0.35);
  }
  .step:hover .step-icon svg { stroke: #fff; }
  .step-arrow {
    font-size: 1.4rem;
    color: var(--border);
    padding-bottom: 20px;
    user-select: none;
  }

  /* ─── Timestamp ──────────────────────────────────────────────── */
  .timestamp-label {
    font-size: 0.78rem;
    color: var(--muted);
    opacity: 0.6;
    min-height: 1.2em;
    letter-spacing: 0.04em;
  }

  /* ─── Pulse bar ──────────────────────────────────────────────── */
  .pulse-bar {
    position: absolute;
    bottom: 0;
    left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), transparent);
    opacity: 0.5;
    animation: slide-bar 4s linear infinite;
  }
  @keyframes slide-bar {
    0%   { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* ─── Responsive ─────────────────────────────────────────────── */
  @media (max-height: 700px) {
    .main-wrap { gap: 18px; }
    .headline h1 { font-size: 1.8rem; }
    .steps { display: none; }
  }
  @media (max-width: 360px) {
    .qr-inner { padding: 16px; }
    .step-arrow { display: none; }
  }
</style>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const qrContainer = document.getElementById('qrCodeDisplay');
  const latestCodeEl = document.getElementById('latestCode');
  const latestTimeEl = document.getElementById('latestTime');
  const codeBadge    = document.getElementById('codeBadge');

  let lastCode = null;

  /* ── Update QR ─────────────────────────── */
  async function updateQR() {
    try {
      const res  = await fetch('/api/latest_qr');
      const data = await res.json();

      if (data && data.qr_image) {
        /* Animate in only when code changes */
        if (data.code !== lastCode) {
          lastCode = data.code;
          qrContainer.innerHTML = `<img src="${data.qr_image}" alt="QR Code">`;
          codeBadge.style.animation = 'none';
          requestAnimationFrame(() => {
            codeBadge.style.animation = 'popIn 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards';
          });
        }
        latestCodeEl.textContent = data.code;
        latestTimeEl.textContent = data.time_display ? `อัปเดต: ${data.time_display}` : '';
      } else {
        qrContainer.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
              <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2
                       M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
              <rect x="7" y="7" width="10" height="10" rx="1"/>
            </svg>
            <h3>รอการถ่ายรูป…</h3>
            <p>ยังไม่มีรูปในระบบ</p>
          </div>`;
        latestCodeEl.textContent = '— — — —';
        latestTimeEl.textContent = '';
        lastCode = null;
      }
    } catch (e) {
      console.error('QR fetch error:', e);
    }
  }

  /* ── Fullscreen on click ────────────────── */
  if (document.documentElement.requestFullscreen) {
    document.querySelector('.qr-page').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(() => {});
      }
    });
  }

  /* ── Poll every 3 s ─────────────────────── */
  setInterval(updateQR, 3000);
  updateQR();
});
</script>

<style>
  /* Badge pop animation (injected by JS so needs to live here) */
  @keyframes popIn {
    0%   { transform: scale(0.85); opacity: 0.4; }
    100% { transform: scale(1);    opacity: 1; }
  }
</style>

{% endblock %}
