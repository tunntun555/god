{% extends "layout.html" %}

{% block title %}รับรูปของคุณ - Photo Booth{% endblock %}

{% block content %}
<div class="qr-page">
    <div class="qr-header">
        <h1><i class="fas fa-qrcode"></i> รับรูปของคุณ</h1>
        <p class="subtitle">สแกน QR Code เพื่อดาวน์โหลดรูปฟรี!</p>
    </div>

    <div class="qr-container">
        <div id="qrCodeDisplay">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> กำลังโหลด QR Code...
            </div>
        </div>

        <div class="qr-info">
            <h3 id="latestCode">รอการถ่ายรูป...</h3>
            <p class="timestamp" id="latestTime"></p>
        </div>

        <div class="instructions">
            <h3><i class="fas fa-mobile-alt"></i> วิธีรับรูป:</h3>
            <ol>
                <li>เปิดแอปกล้องหรือแอปสแกน QR บนมือถือ</li>
                <li>สแกน QR Code นี้</li>
                <li>กดลิ้งค์ที่ปรากฏ</li>
                <li>ดาวน์โหลดรูปได้ทันที!</li>
            </ol>
        </div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <i class="fas fa-camera"></i>
            <span id="totalPhotos">0</span>
            <small>รูปทั้งหมด</small>
        </div>
        <div class="stat-item">
            <i class="fas fa-download"></i>
            <span id="totalDownloads">0</span>
            <small>ดาวน์โหลด</small>
        </div>
        <div class="stat-item">
            <i class="fas fa-users"></i>
            <span id="totalSessions">0</span>
            <small>เซสชัน</small>
        </div>
    </div>
</div>

<script>
// QR Display Auto-Update
document.addEventListener('DOMContentLoaded', function() {
    const qrContainer = document.getElementById('qrCodeDisplay');
    const latestCode = document.getElementById('latestCode');
    const latestTime = document.getElementById('latestTime');
    const totalPhotos = document.getElementById('totalPhotos');
    const totalDownloads = document.getElementById('totalDownloads');
    const totalSessions = document.getElementById('totalSessions');

    // ดึงข้อมูลล่าสุดทุก 3 วินาที
    async function updateQR() {
        try {
            const response = await fetch('/api/latest_qr');
            const data = await response.json();
            
            if (data && data.qr_image) {
                qrContainer.innerHTML = `
                    <img src="${data.qr_image}" alt="QR Code" class="qr-image">
                    <p class="scan-text">สแกนด้วยมือถือ</p>
                `;
                latestCode.textContent = `รหัส: ${data.code}`;
                latestTime.textContent = `เวลา: ${data.time_display || 'ล่าสุด'}`;
            } else {
                qrContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-qrcode"></i>
                        <h3>รอการถ่ายรูป...</h3>
                        <p>ยังไม่มีรูปที่ถ่ายในระบบ</p>
                    </div>
                `;
                latestCode.textContent = 'รอการถ่ายรูป...';
                latestTime.textContent = '';
            }
        } catch (error) {
            console.error('Error fetching QR:', error);
        }
    }

    // ดึงสถิติ
    async function updateStats() {
        try {
            const response = await fetch('/admin?json=true');
            const data = await response.json();
            if (data.stats) {
                totalPhotos.textContent = data.stats.total_photos;
                totalDownloads.textContent = data.stats.total_downloads;
                totalSessions.textContent = data.stats.total_sessions;
            }
        } catch (error) {
            console.error('Error fetching stats:', error);
        }
    }

    // อัปเดตทุก 3 วินาที
    setInterval(updateQR, 3000);
    setInterval(updateStats, 5000);
    
    // โหลดครั้งแรก
    updateQR();
    updateStats();

    // Fullscreen suggestion
    if (document.documentElement.requestFullscreen) {
        document.querySelector('.qr-page').addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            }
        });
        
        // แสดงข้อความแนะนำ Fullscreen
        setTimeout(() => {
            const hint = document.createElement('div');
            hint.className = 'fullscreen-hint';
            hint.innerHTML = 'คลิกที่จอเพื่อเปิด Fullscreen';
            document.querySelector('.qr-page').appendChild(hint);
            setTimeout(() => hint.remove(), 5000);
        }, 2000);
    }
});
</script>

<style>
.qr-page { 
    height: 100vh; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: 20px;
}
.qr-header { margin-bottom: 30px; }
.qr-header h1 { font-size: 3rem; margin-bottom: 10px; }
.subtitle { font-size: 1.5rem; opacity: 0.9; }
.qr-container { 
    background: white; 
    padding: 30px; 
    border-radius: 20px; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    margin-bottom: 30px;
    max-width: 90vw;
}
.qr-image { 
    width: 400px; 
    height: 400px; 
    max-width: 80vw; 
    max-height: 80vw;
    border: 10px solid white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.scan-text { 
    color: #333; 
    font-size: 1.5rem; 
    margin-top: 15px; 
    font-weight: bold;
}
.qr-info { 
    background: rgba(255,255,255,0.1); 
    padding: 15px; 
    border-radius: 10px; 
    margin-top: 20px;
}
#latestCode { font-size: 1.8rem; margin: 10px 0; }
.timestamp { font-size: 1.2rem; opacity: 0.8; }
.instructions { 
    background: rgba(255,255,255,0.1); 
    padding: 20px; 
    border-radius: 10px; 
    margin-top: 20px;
    text-align: left;
    max-width: 500px;
}
.instructions ol { padding-left: 20px; margin-top: 10px; }
.instructions li { margin: 8px 0; }
.stats { 
    display: flex; 
    gap: 30px; 
    margin-top: 20px;
    flex-wrap: wrap;
    justify-content: center;
}
.stat-item { 
    background: rgba(255,255,255,0.1); 
    padding: 15px 25px; 
    border-radius: 10px;
    min-width: 120px;
}
.stat-item i { font-size: 2rem; display: block; margin-bottom: 10px; }
.stat-item span { font-size: 2rem; font-weight: bold; display: block; }
.stat-item small { opacity: 0.8; }
.empty-state { padding: 40px; color: #666; }
.empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
.loading { padding: 40px; font-size: 1.5rem; }
.fullscreen-hint {
    position: fixed;
    bottom: 20px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    animation: fadeInOut 5s;
}
@keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    20%, 80% { opacity: 1; }
}

@media (max-height: 800px) {
    .qr-image { width: 300px; height: 300px; }
    .qr-header h1 { font-size: 2rem; }
    .subtitle { font-size: 1.2rem; }
}
</style>
{% endblock %}